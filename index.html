<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Challenge-Tik-Tak-Toe Multiplayer</title>
<style>
body { font-family: sans-serif; text-align: center; }
.grid {
  display: grid;
  gap: 5px;
  justify-content: center;
  margin-top: 20px;
}
.cell {
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #333;
  font-size: 14px;
  cursor: pointer;
  text-align: center;
  padding: 5px;
  box-sizing: border-box;
  width: 96px; 
  height: 96px;
  color: black;
  word-wrap: break-word;
  position: relative;
  user-select: none;
  background-color: #fff;
}
input, select, button { font-size:16px; padding:5px; margin:5px; }
#playerStats { margin-top: 20px; text-align: left; display:inline-block; }
</style>
</head>
<body>
<h1>Challenge-Tik-Tak-Toe Multiplayer</h1>

<div>
<input type="text" id="nameInput" placeholder="Spielername eingeben"><br>
<input type="color" id="colorInput" value="#3498db"><br>
<label>FeldgrÃ¶ÃŸe:
  <select id="gridSize">
    <option value="3">3x3</option>
    <option value="4">4x4</option>
    <option value="5" selected>5x5</option>
    <option value="6">6x6</option>
    <option value="7">7x7</option>
    <option value="8">8x8</option>
    <option value="9">9x9</option>
  </select>
</label><br>
<button id="startBtn">Spiel starten</button>
</div>

<p id="playerDisplay"></p>
<div class="grid" id="grid"></div>
<button id="resetBtn">ðŸ”„ Neues Spiel starten</button>

<h2>SpielerÃ¼bersicht</h2>
<div id="playerStats"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ðŸ”¹ Firebase initialisieren
const firebaseConfig = {
  apiKey: "AIzaSyCDGnsgg1muZSLsiogP0AydwfRMmnL-rC0",
  authDomain: "lol-bingo.firebaseapp.com",
  databaseURL: "https://lol-bingo-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lol-bingo",
  storageBucket: "lol-bingo.firebasestorage.app",
  messagingSenderId: "346023051769",
  appId: "1:346023051769:web:3bd5bfa276189114d93d28",
  measurementId: "G-MZ52BB5PD5"
};
const firebaseApp = initializeApp(firebaseConfig);
const db = getDatabase(firebaseApp);

// ðŸ”¹ DOM Elemente
const grid = document.getElementById("grid");
const resetBtn = document.getElementById("resetBtn");
const startBtn = document.getElementById("startBtn");
const nameInput = document.getElementById("nameInput");
const colorInput = document.getElementById("colorInput");
const playerDisplay = document.getElementById("playerDisplay");
const gridSizeInput = document.getElementById("gridSize");
const playerStatsDiv = document.getElementById("playerStats");

// ðŸ”¹ Beispiel-Challenges
const challenges = Array.from({length:81},(_,i)=>[`C${i+1}`,`Challenge ${i+1} ausfÃ¼hrlich`]);

let playerName = "";
let playerColor = "";
let gridSize = 5;

// ðŸ”¹ Start Spiel
startBtn.addEventListener("click",()=>{
  if(!nameInput.value.trim()){alert("Bitte gib deinen Namen ein!");return;}
  playerName=nameInput.value.trim();
  playerColor=colorInput.value;
  gridSize=parseInt(gridSizeInput.value);
  playerDisplay.textContent=`Du bist ${playerName} (${playerColor})`;
  set(ref(db,"gridSize"),gridSize);
  nameInput.style.display="none";
  colorInput.style.display="none";
  gridSizeInput.style.display="none";
  startBtn.style.display="none";
  createGrid(gridSize);
});

// ðŸ”¹ Grid erstellen
function createGrid(size){
  grid.innerHTML="";
  grid.style.gridTemplateColumns=`repeat(${size},96px)`;
  const total=size*size;
  for(let i=0;i<total;i++){
    const cell=document.createElement("div");
    cell.classList.add("cell");
    cell.dataset.index=i;
    const shortText=challenges[i]?challenges[i][0]:"";
    const longText=challenges[i]?challenges[i][1]:"";
    cell.dataset.challengeShort=shortText;
    cell.dataset.challengeLong=longText;
    cell.title=longText;
    cell.textContent=shortText;

    cell.addEventListener("click", async (e)=>{
      const fieldRef = ref(db,"board/"+i);
      const snapshot = await onValueOnce(fieldRef);
      const fieldData = snapshot.val() || { players:{} };
      const players = fieldData.players || {};
      const exclusivePlayer = fieldData.exclusivePlayer || null;
      const isSelected = players[playerName] !== undefined;

      if(e.detail === 2){
        if(exclusivePlayer && exclusivePlayer !== playerName) return;
        set(fieldRef, { players: { [playerName]: { color: playerColor } }, exclusivePlayer: playerName });
      } else {
        if(isSelected){
          remove(ref(db,"board/"+i+"/players/"+playerName));
          if(exclusivePlayer === playerName){
            update(fieldRef,{exclusivePlayer:null});
          }
        } else {
          if(exclusivePlayer) return;
          set(ref(db,"board/"+i+"/players/"+playerName), {color: playerColor, exclusive:false});
        }
      }
    });

    grid.appendChild(cell);
  }
}

// ðŸ”¹ Hilfsfunktion: einmaliges Firebase lesen
function onValueOnce(ref){
  return new Promise(resolve=>{
    const off = onValue(ref,snap=>{resolve(snap); off();});
  });
}

// ðŸ”¹ Kontrastfarbe
function getContrastYIQ(hex){
  hex=hex.replace("#","");
  const r=parseInt(hex.substr(0,2),16);
  const g=parseInt(hex.substr(2,2),16);
  const b=parseInt(hex.substr(4,2),16);
  const yiq=((r*299)+(g*587)+(b*114))/1000;
  return yiq>=128?"black":"white";
}

// ðŸ”¹ Firebase Listener & Feldfarben + Statistik
onValue(ref(db), snapshot=>{
  const data = snapshot.val()||{};
  const board = data.board||{};
  const size = data.gridSize||gridSize;
  if(size!==gridSize){gridSize=size;createGrid(gridSize);}

  document.querySelectorAll(".cell").forEach(cell=>{
    const idx = cell.dataset.index;
    const field = board[idx];
    cell.textContent = cell.dataset.challengeShort||"";
    cell.style.border="2px solid #333";
    cell.style.background="#fff";
    cell.style.color="black";

    if(field && field.players){
      const playerArr = Object.entries(field.players);
      if(field.exclusivePlayer){
        const player = field.exclusivePlayer;
        cell.style.backgroundColor = field.players[player].color;
        cell.style.border="3px solid gold";
        cell.style.color=getContrastYIQ(field.players[player].color);
      } else if(playerArr.length>0){
        const colors = playerArr.map(([name,p])=>p.color);
        const percent = 100 / colors.length;
        const gradient = colors.map((c,i)=>`${c} ${i*percent}% ${(i+1)*percent}%`).join(', ');
        cell.style.background = `linear-gradient(to right, ${gradient})`;
        cell.style.color="black";
      }
    }
  });

  // Spielerstatistik
  const playerCounts = {};
  Object.values(board).forEach(field=>{
    if(field.players){
      Object.keys(field.players).forEach(p=>{
        if(!playerCounts[p]) playerCounts[p]=0;
        playerCounts[p]++;
      });
    }
  });
  let statsHTML = "<ul>";
  for(const [name,count] of Object.entries(playerCounts)){
    let color="#000";
    for(const field of Object.values(board)){
      if(field.players && field.players[name]){ color=field.players[name].color; break; }
    }
    statsHTML += `<li><span style="color:${color}">${name}</span>: ${count} Feld${count>1?"er":""}</li>`;
  }
  statsHTML += "</ul>";
  playerStatsDiv.innerHTML = statsHTML;
});

// ðŸ”¹ Reset
resetBtn.addEventListener("click",()=>{
  remove(ref(db,"board"));
  createGrid(gridSize); // Grid leeren & neu rendern
});
</script>
</body>
</html>
